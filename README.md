# Carro Veronica Web Monorepo

This project was generated using [Nx](https://nx.dev).

<p style="text-align: center;"><img width="461" alt="image" src="https://user-images.githubusercontent.com/4533225/154009964-1af3719f-81a5-4d64-8556-066e392aa7a3.png">
</p>

üîé **Smart, Fast and Extensible Build System**

## Development server

Run `yarn setup` to install dependencies.

Ask your team members to get the `.env` files to be placed in each country app folder.

Run `yarn start app-name` to start the development host in each app e.g., `yarn start veronica`. The app will automatically
reload if you change any of the source files.

## Build

Run `yarn build my-app` to build the project e.g, `yarn build veronica`. The build artifacts will be stored in
the `dist/` directory. Use the `--prod` flag for a production build.

In order to test the build locally, please follow the steps below:

- Copy the `server` folder in a particular app, then paste to the built artifact location in the `dist/` folder.
- Use `cd` command to navigate to the build artifact in the `dist/` folder.
- Run `npm install` to set up dependencies.
- Run `npm run start-server` to start the production build on local machine. The application will be run on localhost: 8081.

## Running unit tests

Run `nx test my-app` to execute the unit tests via [Jest](https://jestjs.io).

Run `nx affected:test` to execute the unit tests affected by a change.

## Running end-to-end tests

Run `ng e2e my-app` to execute the end-to-end tests via [Cypress](https://www.cypress.io).

Run `nx affected:e2e` to execute the end-to-end tests affected by a change.

## Understand your workspace

Run `nx dep-graph` to see a diagram of the dependencies of your projects.

## Generate an application

Run `nx g @nrwl/react:app my-app` to generate an application.

> You can use any of the plugins above to generate applications as well.

When using Nx, you can create multiple applications and libraries in the same workspace.

## Code scaffolding

Run `nx g @nrwl/react:component my-component --project=my-app` to generate a new component.

Libraries are shareable across libraries and applications. They can be imported from `@carro-rabbit-mono-nx/mylib`.

## Further help

Visit the [Nx Documentation](https://nx.dev) to learn more.

## ‚òÅ Nx Cloud

### Distributed Computation Caching & Distributed Task Execution

<p style="text-align: center;"><img src="https://raw.githubusercontent.com/nrwl/nx/master/images/nx-cloud-card.png"></p>

Nx Cloud pairs with Nx in order to enable you to build and test code more rapidly, by up to 10 times. Even teams that
are new to Nx can connect to Nx Cloud and start saving time instantly.

Teams using Nx gain the advantage of building full-stack applications with their preferred framework alongside Nx‚Äôs
advanced code generation and project dependency graph, plus a unified experience for both frontend and backend
developers.

Visit [Nx Cloud](https://nx.app/) to learn more.

## Design

- [Figma](https://www.figma.com/file/Y4AVBtWj8ldXHE6b2JRBOX/CX-App---O2O-Showroom-Experience?node-id=2480%3A37617)

## üéë Theme

### Material

- [Antd default variable](https://github.com/ant-design/ant-design/blob/master/components/style/themes/default.less)
- [Antd theme](https://antdtheme.com/)
- [Tailwind theme](https://tailwindcss.com/docs/theme)

### How to modify antd theme

- Go [Antd variable](https://github.com/ant-design/ant-design/blob/master/components/style/themes/default.less)
  , [Antd theme](https://antdtheme.com/)
  to find variable which you want to change
- Add variable to [antdTheme.js](apps/veronica/src/styles/antdTheme.js)
- If you want to use variable for global, go [tailwind-workspace.js](tailwind-workspace.js) and modify theme

**Ex:** You want to change antd primary-color to `#FAAD14` and apply primary-color for tailwind to use in project

1. Add `'@primary-color': '#4082FF'` to [antdTheme.js](apps/veronica/src/styles/antdTheme.js)

```js
module.exports = {
  '@primary-color': '#4082FF',
};
```

2. Apply `primary-color` for tailwind, go [tailwind-workspace.js](tailwind-workspace.js)

```javascript
const defaultTheme = require('tailwindcss/defaultTheme');

module.exports = {
  // ...
  theme: {
    // ...
    extend: {
      //...
      colors: {
        primary: 'var(--primary-color)',
        // ...
      },
      // ...
    },
  },
  // ...
};
```

> **Note**: `--primary-color` will be generated by `@primary-color`, replace `@` by `--`

## üíÖ Styling

### Material

- [Tailwindcss](https://tailwindcss.com/)
- [twin.macro (with Emotion presets)](https://github.com/ben-rogerson/twin.macro)

### Example

#### Modify component style using `styled`

```typescript jsx
import tw, { styled } from 'twin.macro';

const StyledInput = styled.input`
  color: black;
  ${({ hasBorder }) => hasBorder && tw`border-purple-500`}
`;
const Dropdown = () => <StyledInput hasBorder />;
```

```typescript jsx
import { Button as AntdButton, ButtonProps as AntdButtonProps } from 'antd';
import tw, { css, styled } from 'twin.macro';

const StyleButton = styled(AntdButton)`
  // Using tailwind class
  ${tw`flex items-center`}
  ${tw`px-[14px] py-[12px] border-none shadow-none`}
  ${tw`text-xs uppercase font-bold`}
  
  // Write normal CSS
  text-shadow: none;
  height: fit-content;

  &,
  &:hover,
  &:focus {
    ${tw`bg-secondary text-black-base`}
  }

  &.ant-btn-primary {
    // Condition
    ${({ selected }: ButtonProps) =>
      selected
        ? tw`bg-[#2439B0] text-white`
        : css`
            ${tw`text-primary`}
            &, &:hover, &:focus {
              background: linear-gradient(
                  0deg,
                  rgba(94, 129, 244, 0.1),
                  rgba(94, 129, 244, 0.1)
                ), #ffffff;
            }
          `}

    &.ant-btn-lg {
      ${tw`text-[26px]`}
    }
  }
`;

export const Button: React.FC<ButtonProps> = (props) => {
  return <StyleButton {...props} />;
};
```

#### Create style component using `css` or `tw`

```typescript jsx
import tw, { css } from 'twin.macro';

const styles = css`
  ${tw`border`}

  &:hover {
    border-color: black;
    ${tw`text-black-base`}
  }
`;

const Dropdown = () => <input css={styles} />;

const PurpleInput = tw(Dropdown)`border-purple-500`;
```

#### Using as component props

```typescript jsx
const Dropdown = () => <input tw="border hover:border-black-base" />;

const InputHover = ({ hasHover }) => (
  <input css={[tw`border`, hasHover && tw`hover:border-black-base`]} />
);
```

## üåè Internationalization

- Add more language
  1. go [i18next-parser.config.js](i18next-parser.config.js), add new locale into `locales` array
  2. Run
  ```shell
  yarn extract-lang
  ```
  This script automate generate locales folder base on `locales` array

> To edit translation content, go every folder of every country to update, DON'T EDIT `all-locales.json`, it just json
> file was generated by script, will be override when `yarn extract-lang` excecute

## üõ†Ô∏è How to generate a new library module?

- Run the commands below, make sure to change the `{moduleName}` accordingly:

  ```
  yarn nx generate @nrwl/react:library {moduleName} --style=@emotion/styled --directory=modules --buildable --no-component --importPath=@carro/{moduleName} --compiler=swc --pascalCaseFiles --tags=scope:lib:module --no-interactive --dry-run
  ```

  ```
  yarn nx generate @nrwl/react:library {moduleName}-shared --style=@emotion/styled --directory=modules --buildable --no-component --importPath=@carro/{moduleName}-shared --compiler=swc --pascalCaseFiles --tags=scope:lib:module-shared --no-interactive --dry-run
  ```

- Double check if the files to be created are correct
- If correct, remove `--no-interactive --dry-run` and run the command.
- Update `tsconfig.base.json`, add new paths

```
"@carro/{moduleName}/*": ["libs/modules/{moduleName}/src/*"],
"@carro/{moduleName}-shared/*": ["libs/modules/{moduleName}-shared/src/*"],
```

### Config Module Lib

1. Replace `src/lib` folder name to `src/components`

2. Copy over `types` folder from other projects. TODO: It's better if we can find a way to configure types globally.

3. Update imports in the `index.ts` file

<!-- 4. Create `service.tsx` file

```jsx
import dynamic from 'next/dynamic';
import { CoreInterfaces } from '@carro/utils';

export const TicketService: CoreInterfaces.ModuleServiceConfig = {
  name: '{moduleName}',
  injections: [],
};
``` -->

5. Update `.babelrc` to `.babelrc.js` and paste this code:

```javascript
const defaultConfig = require('../../../babel-workspace');

module.exports = {
  ...defaultConfig,
  presets: [
    [
      '@nrwl/react/babel',
      {
        runtime: 'automatic',
        useBuiltIns: 'usage',
        importSource: '@emotion/react',
      },
    ],
  ],
};
```

6. Update `jest.config.js`, paste this code, remember to replace `{moduleName}`

```javascript
module.exports = {
  displayName: 'modules-{moduleName}',
  preset: '../../../jest.preset.js',
  transform: {
    '^.+\\.[tj]sx?$': 'babel-jest',
    '^.+.(css|styl|less|sass|scss|png|jpg|ttf|woff|woff2)$':
      'jest-transform-stub', // anything style related is ignored and mapped to jest-transform-stub module
  },
  moduleFileExtensions: ['ts', 'tsx', 'js', 'jsx'],
  coverageDirectory: '../../../coverage/libs/modules/{moduleName}',
  setupFilesAfterEnv: [
    '@testing-library/jest-dom/extend-expect',
    'jest-axe/extend-expect',
    '../../../jest.setup.js',
  ],
};
```

7. Set up `test/index.tsx` folder. Paste the script below:
   **Remember to replace the comment lines with the necessary dependencies once they are ready**

```typescript
import { configureStore, combineReducers } from "@reduxjs/toolkit";

import { baseRender } from "@carro/test/base";
import { rootApiV1 } from "@carro/store/api";

// import { moduleApi } from '@carro/module-shared/api';

const reducer = combineReducers({
  [rootApiV1.reducerPath]: rootApiV1.reducer,
  //   [moduleApi.reducerPath]: moduleApi.reducer,
});

type RootState = ReturnType<typeof reducer>;

export type MockApiState = {
  api: {
    queries?: any;
    mutation?: any;
  };
  //   moduleApi: {
  //     queries?: any;
  //     mutation?: any;
  //   };
};

export type MockRootState = Partial<
  Omit<
    RootState,
    "api"
    // | "moduleApi"
  > &
    MockApiState
>;

export const makeStore = (reduxToolkitStoreOptions) => {
  const appStore = configureStore({
    reducer,
    middleware: (getDefaultMiddlewares) => [
      ...getDefaultMiddlewares(),
      rootApiV1.middleware,
      //   moduleApi.middleware,
    ],
    devTools: true,
    preloadedState: {},
    ...reduxToolkitStoreOptions,
  });
  return appStore;
};

export const render = baseRender<MockRootState>(makeStore);

export * from "@carro/test/base";
export * as mock from "./mock";
```

### Config Module-Shared Lib

1. Do same as the **Step 5** above
2. This shared library can contain `api`, `store`, `selectors`, `interfaces` which can be shared to other modules. 
It's only used for sharing logic, not UI components.

## üõ†Ô∏è How to generate a new component?

Common usage:

```shell
  yarn generate component `ComponentName` --project=`projectName`
```

The `yarn generate component` supports below options:
| Option | Type/Required | Description
| ------ | ------------- | -----------
| `arg[0]` | `string` `required` | The name of the component that you want to create.
| `--project` | `string` `required` | The name of the project that the component is going to be created in. Find the project name in the `<rootDir>/workspace.json` file.
| `--directory` | `string` | The relative path from the `components` folder. E.g. `/Form/Input` will create files under `/components/Form/Input` of the project.
| `--export` | `boolean` | The default value is `true` which automatically adds an export line into the `/components`'s `index.ts` file.
| `--no-interactive --dry-run` | | use this option to see what files are going to be created.
